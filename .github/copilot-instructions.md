# Ruyi Copilot Instructions

- **Purpose**: Ruyi is a Discord bot (Nine Sols theme) that streams LLM replies, uses OpenRouter tools, and stores chat/memory state in MongoDB. Core flow: [src/main.ts](src/main.ts) boots DB/config/memory caches then starts the bot.
- **Run it**: `bun install` then `bun run --watch src/main.ts`; set `DISCORD_TOKEN`, `MODEL_TOKEN`, optional `MONGO_URI` (default localhost), `PROVISIONING_KEY` (credits lookup).
- **Discord handling**: Events and login live in [src/bot.ts](src/bot.ts). `registerEvents()` wires message create/delete, slash commands, and kicks off the periodic message sync service. `startBot()` fatals if the token is missing.
- **Reply gating**: `shouldBotRespond()` checks mentions/DMs first, then calls `shouldReply()` (LLM yes/no classifier in [src/ai.ts](src/ai.ts)) to avoid spam replies. Keep this lightweight and resilient; failures default to no-response.
- **Status UX**: Replies post a live status embed built from [src/utils/status.ts](src/utils/status.ts); tool start/finish events update the embed, and typing indicators pause during tool calls.
- **Message context**: `fetchReplyChain`, `fetchChatHistory`, and `fetchReferencedMessage` in [src/utils/messages.ts](src/utils/messages.ts) gather recent Discord context; replies are chunked with `sendReplyChunks()` to stay under Discord limits.
- **LLM call**: `chat()` in [src/ai.ts](src/ai.ts) builds a system prompt (Ruyi persona), loads history from DB when Discord history is short, streams via `OpenRouter.callModel`, and tracks tool events. If `getText()` is empty, it warns and returns null.
- **Memory rules**: `rememberMessage()` writes channel history to Mongo `Conversation` with a 100-message cap; `lastInteractionCache` keeps rolling timestamps for ongoing conversations. `memory_*` tools in [src/tools/memory.ts](src/tools/memory.ts) enforce username-based user scope (Discord username only), truncate stored values to 500 chars, and evict oldest records past 50 global / 30 user memories.
- **Tools pattern**: Tools live in [src/tools](src/tools) and are exported via the `allTools` array in [src/tools/index.ts](src/tools/index.ts). Each tool uses `tool()` + Zod schema; context comes from `setToolContext()` in [src/utils/types.ts](src/utils/types.ts). When writing tools, always handle null channel/guild/message and return structured errors.
- **Message/search tools**: `search_messages` and `delete_messages` in [src/tools/message.ts](src/tools/message.ts) use the tool context to fetch channels, filter by author/query, and support bulk deletion with two-week cutoff logic.
- **Commands**: Message commands use the cached prefix from Mongo config ([src/config.ts](src/config.ts)); only `!ping` exists in [src/commands](src/commands). Slash commands `/prefix` (view/change) and `/credits` (OpenRouter balance) are registered at startup from [src/slashCommands](src/slashCommands).
- **Persistence**: Mongo models live in [src/db/models](src/db/models) (`Config`, `Conversation`, `Memory`). `connectDB()` in [src/db/index.ts](src/db/index.ts) exits the process on disconnect/error after initial connect.
- **Sync service**: [src/services/messageSync.ts](src/services/messageSync.ts) periodically prunes DB messages that were deleted in Discord; rate-limits with batches and delays. Avoid heavy per-message fetches elsewhere.
- **Logging**: Use the child loggers in [src/logger.ts](src/logger.ts) (`botLogger`, `aiLogger`, `toolLogger`, `syncLogger`). Keep structured context (user/channel/tool) in logs.
- **System prompt expectations**: Ruyi persona, English default, no speaker prefixes, embraces being an AI character, and requires `memory_recall` / `memory_store` for personal facts. Respect tool usage hints in the prompt (e.g., search first, use embeds for structured data, avoid emojis in text).
- **Safety/limits**: Discord message length handling happens via chunking; tools should guard against missing permissions or wrong channel types. Mongo writes should be bounded (slices, limits) to prevent unbounded growth.
- **Adding features**: When adding commands/tools, update `slashCommands` or `allTools` exports and ensure `setToolContext()` is invoked before tool execution (bot already does this). Keep schemas descriptiveâ€”tool descriptions are surfaced to the model.

If anything here is unclear or missing, tell me what to adjust.